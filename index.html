<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zeiterfassung</title>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="apple-touch-icon" href="apple-touch-icon.png">

<style>
:root{
  --bg:#c0d2d392;
  --card:#fff;
  --border:#66819b42;
  --text:#1f1f1f;
  --accent:#427da1;
  --danger:#c94a4a;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Inter',system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* NAV */
nav{display:flex;background:#1f1f1f}
nav button{
  flex:1;padding:1.2rem;border:none;background:none;
  color:#aaa;font-size:1.1rem
}
nav button.active{
  color:#fff;border-bottom:8px solid var(--accent)
}

/* PAGE */
.page{
  min-height:calc(100vh - 56px);
  padding:1.4rem;
  display:flex;
  flex-direction:column;
}

/* HOME */
.timer-wrapper{flex:1;display:flex;flex-direction:column;align-items:center}
.top-area{width:100%;max-width:380px}

.project-select{
  width:100%;font-size:1.3rem;padding:1rem;
  border-radius:18px;border:1px solid var(--border);
  background-color: #ffffff;
  text-align:center;font-weight:700
}

.timer{
  margin-top:1.6rem;
  width:100%;
  text-align:center;
  font-family:"Courier New",monospace;
  font-size:clamp(2.4rem,10vw,3.6rem);
  line-height:1.3;
  padding:1.6rem .6rem;
  border-radius:28px;
  background:#fafafa;
  border:2px solid var(--border);
}

.flex-spacer{flex:1}

/* MAIN BUTTON */
.main-btn{
  width:220px;height:220px;border-radius:50%;
  border:none;font-size:1.5rem;font-weight:800;
  color:#fff;background:var(--accent);
  box-shadow:0 14px 30px rgba(0,0,0,.18);
  margin-bottom:4rem;
  margin-top: 2rem;
}
.main-btn.stop{
  background:var(--danger);
  animation:pulse 1.4s infinite
}
@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(201,74,74,.6)}
  70%{box-shadow:0 0 0 22px rgba(201,74,74,0)}
  100%{box-shadow:0 0 0 0 rgba(201,74,74,0)}
}
.todo-section {
  margin-top: 1.2rem;
}

.todo-item {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:.8rem .6rem;
  border-radius:10px;
  background:#f6f6f6;
  margin-bottom:.5rem;
}

.todo-left {
  display:flex;
  align-items:center;
  gap:.8rem;
  flex:1;
  cursor:pointer;
}

.todo-checkbox {
  width:22px;
  height:22px;
  border:2px solid #999;
  border-radius:6px;
  transition:.2s;
}

.todo-checkbox.done {
  background:#111;
  border-color:#111;
}

.todo-left span.done {
  text-decoration:line-through;
  opacity:.6;
}

.todo-delete {
  border:none;
  background:none;
  font-size:1.1rem;
  color:#999;
  cursor:pointer;
}

.todo-input-row {
  display:flex;
  gap:.5rem;
  margin-top:.8rem;
}

.todo-input-row input {
  flex:1;
  padding:.6rem;
  border-radius:8px;
  border:1px solid #ddd;
}

.todo-input-row button {
  width:42px;
  border:none;
  border-radius:8px;
  background:#111;
  color:white;
  font-size:1.2rem;
  cursor:pointer;
}

/* PROJECT LIST */
.project-item{
  position:relative;
  background:#fff;
  border-top-left-radius: 8px;
  border-bottom-left-radius: 8px;
  border-top-right-radius: 20px;
  border-bottom-right-radius: 20px;
  padding:0.6rem 0.6rem 0.6rem 1.5rem;
  margin-bottom:1.1rem;
  font-size:1rem;
  font-weight:700;
}
.project-item span{
  display:block;margin-top:.4rem;font-size:0.75rem
  
}
.project-item::before{
  content:"";position:absolute;left:0px;top:0%;bottom:0%;
  width:8px;border-bottom-left-radius: 20px; border-top-left-radius: 20px ;background:var(--accent)
}

/* MODAL */
.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.45);
  display:flex;justify-content:center;align-items:center;
  z-index:20
}
.modal-card{
  position:relative;background:#fff;width:92%;
  max-width:480px;border-radius:24px;
  padding:1.6rem 1.4rem;
  max-height:85vh;overflow-y:auto
}
.modal-close{
  position:absolute;top:.7rem;right:.7rem;
  width:36px;height:36px;border-radius:50%;
  background:#999;color:#fff;border:none;
  font-size:1.3rem;font-weight:700
}

textarea{
  width:100%;min-height:100px;padding:.8rem;
  border-radius:14px;border:1px solid var(--border);
  font-size:1rem
}

.entry{background-color:#e4e4e4a2;border-radius:20px;padding:.9rem; margin-bottom:1rem}
.entry-top{display:flex;justify-content:space-between;align-items:center}
.entry-delete{
  border:none;background:#c0c0c05b;border-radius:50%;
  width:32px;height:32px
}

/* BOTTOM ACTIONS */
.bottom-actions{display:flex;gap:.8rem;margin-top:1rem}
.bottom-actions button{
  flex:1;padding:.9rem;border-radius:16px;
  border:none;font-size:1.1rem;font-weight:600;
  background:var(--accent);color:#fff
}

.pause-container{
  height:60px;              /* fester Platz f√ºr Pause-Button */
  display:flex;
  align-items:flex-start;
  justify-content:center;
  margin-top:1.2rem;
  margin-bottom: 2rem;
}

.pause-btn{
  padding:1.5rem 3rem;
  border-radius:14px;
  border:1px solid var(--border);
  background:#fff;
  font-weight:600;
}

.icon-btn{
  width:70px;
  height:70px;
  border-radius:50%;
  font-size:1rem;     /* ‚¨Ö gr√∂√üer */
  display:flex;
  align-items:center;
  justify-content:center;
  padding:0;
}


</style>
</head>

<body>
<div id="app">

<nav>
  <button :class="{active:tab==='home'}" @click="tab='home'">Timer</button>
  <button :class="{active:tab==='days'}" @click="tab='days'">Tagesansicht</button>
  <button :class="{active:tab==='projects'}" @click="tab='projects'">Projektansicht</button>
</nav>

<!-- HOME -->
<div v-if="tab==='home'" class="page">
  <div class="timer-wrapper">
    <div class="top-area">
      <select class="project-select" v-model="selectedProjectId">
        <option disabled value="">Projekt ausw√§hlen</option>
        <option v-for="p in projects" :value="String(p.id)">{{p.name}}</option>
      </select>
      <div class="timer">{{formattedTime}}</div>
    </div>

<div class="flex-spacer"></div>

<button v-if="!running" class="main-btn" @click="start">Start</button>
<button v-else
        :class="['main-btn', !paused ? 'stop' : '']"
        @click="stop">
  Stop
</button>

<div class="pause-container">
  <button v-if="running"
          @click="paused ? resume() : pause()"
          class="pause-btn icon-btn">

    <span v-if="!paused">Pause</span>
    <span v-else>‚ñ∂</span>

  </button>
</div>
</div>  <!-- timer-wrapper -->
</div>  <!-- HOME page -->

<!-- NOTE MODAL -->
<div v-if="showNote" class="modal">
  <div class="modal-card">
    <button class="modal-close" @click="skipNote">√ó</button>
    <h3>Beschreibung</h3>
    <textarea v-model="note"></textarea>
    <button style="margin-top:1rem;width:100%" @click="saveEntry">Speichern</button>
  </div>
</div>

<!-- PROJECT OVERVIEW -->
<div v-if="tab==='projects'" class="page">
  <div v-for="p in projects" :key="p.id"
       class="project-item"
       :style="{'--accent':p.color}"
       @click="openProject(p)">
    {{p.name}}
    <span>{{(p.total/3600).toFixed(2)}} Stunden</span>
  </div>

  <div class="bottom-actions">
    <button @click="addProject">Projekt hinzuf√ºgen</button>
    <button @click="exportAll">Export</button>
  </div>
  <label style="display:block;margin-bottom:.4rem; margin-top: 1.5rem;"> </label>

<select v-model="selectedUser"
        style="width:100%;padding:0.8rem;margin-bottom:1rem; background-color: #ffffff;">
  <option disabled value="">Benutzer ausw√§hlen</option>
  <option v-for="u in users" :key="u" :value="u">
    {{ u }}
  </option>
</select>
<div v-if="lastExport"
     style="margin-top:1rem;
            font-size:.85rem;
            color:#666;
            text-align:center;">

  Zuletzt exportiert am
  {{ new Date(lastExport).toLocaleDateString('de-DE') }}
  um
  {{ new Date(lastExport).toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'}) }}

</div>
</div>

<!-- PROJECT DETAIL -->
<div v-if="selectedProject" class="modal">
  <div class="modal-card">
    <button class="modal-close" @click="selectedProject=null">√ó</button>

    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin-top: 2rem;">{{selectedProject.name}}</h2>
      <button
        style="border:none;background:none;color:var(--danger);font-size:1.1rem"
        @click="deleteProject"
      >
        Projekt l√∂schen
      </button>
    </div>

<div v-for="(e,i) in selectedProject.entries" :key="e.id" class="entry">

  <div class="entry-top">
<!-- WENN NICHT EXPORTIERT -->
<input v-if="!e.exported"
       type="date"
       :value="e.start.slice(0,10)"
       @input="val => {
         const newDate = val.target.value;
         const start = new Date(e.start);
         const end = new Date(e.end);

         const [year,month,day] = newDate.split('-');
         start.setFullYear(year, month-1, day);
         end.setFullYear(year, month-1, day);

         e.start = start.toISOString();
         e.end = end.toISOString();

         updateDuration(e);
       }"
       style="font-weight:600;border:none;background:transparent">

<!-- WENN EXPORTIERT -->
<div v-else style="font-weight:600">
  {{ formatDay(e.start.slice(0,10)) }}
</div>
    <button class="entry-delete" @click="deleteEntry(i)">üóëÔ∏è</button>
  </div>

  <div style="margin:.4rem 0; display:flex; gap:.6rem; align-items:center">

<!-- START -->
<template v-if="!e.exported">
  <input type="time"
         :value="formatTime(e.start)"
         @input="val => {
           const d = new Date(e.start);
           const [h,m] = val.target.value.split(':');
           d.setHours(h,m);
           e.start = d.toISOString();
           updateDuration(e);
         }">
</template>

<template v-else>
  <span>{{ formatTime(e.start) }}</span>
</template>

<span>‚Äì</span>

<!-- END -->
<template v-if="!e.exported">
  <input type="time"
         :value="formatTime(e.end)"
         @input="val => {
           const d = new Date(e.end);
           const [h,m] = val.target.value.split(':');
           d.setHours(h,m);
           e.end = d.toISOString();
           updateDuration(e);
         }">
</template>

<template v-else>
  <span>{{ formatTime(e.end) }}</span>
</template>

           <div style="font-weight:500;font-size: 0.9rem;">
  <span v-if="e.paused && e.paused > 0">
     + {{ Math.floor(e.paused / 60) }} min Pause
  </span>
</div>



  </div>

<div style="font-weight:600;margin-bottom: 0.5rem;">
 = {{ (e.duration / 3600).toFixed(2) }} h
</div>


  <textarea v-if="!e.exported"
          v-model="e.note"
          @change="save"></textarea>

<div v-else
     style="white-space:pre-wrap;color:#444;padding:.4rem 0">
  {{ e.note }}
</div>

</div>

<div class="todo-section" v-if="selectedProject">

  <h3>ToDo</h3>

  <div v-for="(todo, i) in selectedProject.todos"
       :key="todo.id"
       class="todo-item">

    <div class="todo-left"
         @click="todo.done = !todo.done; save()">

      <div class="todo-checkbox"
           :class="{done: todo.done}">
      </div>

      <span :class="{done: todo.done}">
        {{ todo.text }}
      </span>

    </div>

    <button class="todo-delete"
            @click="deleteTodo(i)">
      ‚úï
    </button>

  </div>

  <div class="todo-input-row">
    <input type="text"
           v-model="newTodo"
           placeholder="Neues ToDo hinzuf√ºgen..."
           @keyup.enter="addTodo">
    <button @click="addTodo">+</button>
  </div>

</div>

  </div>
</div>

<!-- DAY DETAIL MODAL -->
<div v-if="dayDetail" class="modal">
  <div class="modal-card">
    <button class="modal-close" @click="selectedDay=null">√ó</button>

    <h3 style="margin:0">
      {{ formatDay(dayDetail.date) }}
    </h3>

    <p style="margin:.4rem 0 1rem 0;font-weight:700">
      ‚è± {{ (dayDetail.totalSeconds / 3600).toFixed(2) }} Stunden
    </p>

    <div style="margin-bottom:1rem">
  <label style="font-size:.9rem">√úber-/Minusstunden</label>
<input v-if="!exportedAdjustments[dayDetail.date]"
       type="number"
       step="0.25"
       :value="dailyAdjustments[dayDetail.date] || 0"
       @input="val => {
         dailyAdjustments[dayDetail.date] =
           parseFloat(val.target.value) || 0;
         save();
       }"
       style="width:100%;padding:.4rem;margin-top:.4rem">
<div v-else
     style="margin-top:.4rem;font-weight:600;
            color: dailyAdjustments[dayDetail.date] > 0 ? 'green' : 'red'">

  {{ dailyAdjustments[dayDetail.date] > 0 ? '+' : '' }}
  {{ dailyAdjustments[dayDetail.date].toFixed(2) }} h


</div>
</div>


<div v-for="p in dayDetail.projects" :key="p.name"
     style="
       position:relative;
       margin-bottom:1.2rem;
       padding:0.6rem 0.6rem 0.6rem 1.2rem;
       border-radius:14px;
       background:#b1bcc82d;
     ">
      <span
    :style="{
      position: 'absolute',
      left: 0,
      top: '0%',
      bottom: '0%',
      width: '8px',
      borderBottomLeftRadius: '8px',
      borderTopLeftRadius: '8px',
      background: p.color

    }">
  </span>



      <div style="display:flex;justify-content:space-between;align-items:center;
                  font-weight:700;margin-bottom:.4rem">

        <span>{{ p.name }}</span>

        <span style="font-size:1rem">
          {{ (p.seconds / 3600).toFixed(2) }} h
        </span>

      </div>

      <div v-for="e in p.entries" :key="e.id"
           style="padding:.4rem 0;border-bottom:1px solid #eee;
                  font-size:.85rem">

  
<span style="font-weight:400">
  {{ (e.duration / 3600).toFixed(2) }} h
</span>

        <div v-if="e.note" style="color:#666">
          {{ e.note }}
        </div>

      </div>
    </div>

  </div>
</div>



<!-- DAY OVERVIEW -->
<div v-if="tab==='days'" class="page">

<div
  style="
    padding:1rem;
    margin-bottom:1.5rem;
    background:#fff;
    border-radius:18px;
    border:1px solid var(--border);
    text-align:center;
    font-weight:700;
    font-size:0.9rem;
  "
  :style="{ color: totalAdjustment > 0 ? 'green' : (totalAdjustment < 0 ? 'red' : 'inherit') }"
>
  √úber-/Minusstunden Gesamt:
  {{ totalAdjustment > 0 ? '+' : '' }}
  {{ totalAdjustment.toFixed(2) }} h
</div>


<div v-for="d in daysOverview"
     :key="d.date"
     class="project-item"
     style="cursor:pointer"
     @click="openDay(d.date)">


<!-- Kopfzeile -->
<div style="display:flex;justify-content:space-between;align-items:center">

  <span style="font-size: 1rem;">
    {{ formatDay(d.date) }}
  </span>

  <span v-if="dailyAdjustments[d.date]"
        :style="{
          color: dailyAdjustments[d.date] > 0 ? 'green' : 'red'
          }">
    {{ dailyAdjustments[d.date] > 0 ? '+' : '' }}
    {{ dailyAdjustments[d.date].toFixed(2) }} h
  </span>

</div>

<!-- Normale Stunden darunter -->
<span style="font-size:0.85rem; margin-top:.4rem; display:block;">
  {{ (d.seconds / 3600).toFixed(2) }} Stunden
</span>

  </div>

  <div v-if="!daysOverview.length"
       style="text-align:center;color:#777;margin-top:3rem">
    Noch keine Eintr√§ge vorhanden
  </div>

</div>


</div>

<script>
const EXPORT_URL = "https://script.google.com/macros/s/AKfycbybPVsyCMPSffBkGEx6zKn7QzP5-JS8VdsyCGlUTgT8mcB1P2pZs4VU3JexYkmYipiRYA/exec";
                    
const { createApp } = Vue;

createApp({
  data() {
    return {
      tab: 'home',
      projects: JSON.parse(localStorage.getItem('projects') || '[]'),
      selectedProjectId: localStorage.getItem('selectedProjectId') || '',
      selectedProject: null,
      timer: null,
      elapsed: 0,           // aktive Zeit in Sekunden
      showNote: false,
      note: '',
      newTodo: "",
      users: ["Bennet", "Dennis", "Till", "Nicole", "Patrick"],
      selectedUser: localStorage.getItem("selectedUser") || "",
      selectedDay: null,
      dailyAdjustments: JSON.parse(localStorage.getItem('dailyAdjustments') || '{}'),
      lastExport: localStorage.getItem('lastExport') || null,
      running: JSON.parse(localStorage.getItem('timerRunning') || 'false'),
      startTime: JSON.parse(localStorage.getItem('timerStart') || 'null'),
      paused: JSON.parse(localStorage.getItem('timerPaused') || 'false'),
      pausedTime: JSON.parse(localStorage.getItem('timerPausedTime') || '0'),
      pauseStart: JSON.parse(localStorage.getItem('timerPauseStart') || 'null'),
      exportedAdjustments: JSON.parse(localStorage.getItem('exportedAdjustments') || '{}'),
    }
  },

  computed: {

    totalAdjustment() {
    return Object.values(this.dailyAdjustments)
    .reduce((sum, val) => sum + val, 0);
    },


    formattedTime() {
      const s = Math.floor(this.elapsed);
      return (
        String(Math.floor(s / 3600)).padStart(2, '0') + ':' +
        String(Math.floor((s % 3600) / 60)).padStart(2, '0') + ':' +
        String(s % 60).padStart(2, '0')
      );
    },

    daysOverview() {
      const map = {};
      this.projects.forEach(p => {
        p.entries.forEach(e => {
          const day = e.start.slice(0, 10);
          if (!map[day]) map[day] = { date: day, seconds: 0 };
          map[day].seconds += e.duration;
        });
      });
      return Object.values(map).sort((a, b) => b.date.localeCompare(a.date));
    },

dayDetail() {
  if (!this.selectedDay) return null;

  const projectsMap = {};
  let totalSeconds = 0;

  this.projects.forEach(p => {
    (p.entries || []).forEach(e => {
      const day = e.start.slice(0, 10);
      if (day !== this.selectedDay) return;

      if (!projectsMap[p.id]) {
        projectsMap[p.id] = {
          name: p.name,
          color: p.color,
          seconds: 0,
          entries: []
        };

        
      }

  

      projectsMap[p.id].seconds += e.duration || 0;
      totalSeconds += e.duration || 0;
      projectsMap[p.id].entries.push(e);
    });
  });

  // Wenn es keine Eintr√§ge gibt, trotzdem leeres Modal erzeugen
  if (Object.keys(projectsMap).length === 0) {
    return {
      date: this.selectedDay,
      totalSeconds: 0,
      projects: []
    };
  }

  return {
    date: this.selectedDay,
    totalSeconds,
    projects: Object.values(projectsMap)
  };
}
  },
 

  watch: {
    selectedUser(newVal) {
      if (newVal) localStorage.setItem("selectedUser", newVal);
    },
    selectedProjectId(newVal) {
    localStorage.setItem('selectedProjectId', newVal || '');
  },
    showNote(newVal) {
      if (newVal) {
        this.$nextTick(() => {
          if (this.$refs.noteField) this.$refs.noteField.focus();
        });
      }
    }
  },
  

mounted() {
  const running = localStorage.getItem('timerRunning') === 'true';
  const start = localStorage.getItem('timerStart');

  if (!running || !start) {
    this.running = false;
    this.paused = false;
    this.elapsed = 0;
    return;
  }

  this.running = true;
  this.startTime = parseInt(start);

  this.paused = localStorage.getItem('timerPaused') === 'true';
  this.pausedTime = parseFloat(localStorage.getItem('timerPausedTime') || '0');
  this.pauseStart = localStorage.getItem('timerPauseStart');

  if (this.paused) {
    return; // ‚ùó Kein Intervall starten wenn pausiert
  }

  this.timer = setInterval(() => {
    const now = Date.now();
    this.elapsed = Math.floor(
      (now - this.startTime - this.pausedTime * 1000) / 1000
    );
  }, 1000);
},

  methods: {
start() {
  if (!this.selectedProjectId) return alert("Bitte Projekt w√§hlen");

  this.running = true;
  this.paused = false;
  this.pausedTime = 0;
  this.pauseStart = null;

  this.startTime = Date.now();

  this.timer = setInterval(() => {
    const now = Date.now();
    this.elapsed = Math.floor((now - this.startTime - this.pausedTime * 1000) / 1000);
  }, 1000);
  localStorage.setItem('timerRunning', true);
localStorage.setItem('timerStart', this.startTime);
localStorage.setItem('timerPaused', false);
localStorage.setItem('timerPausedTime', 0);
localStorage.removeItem('timerPauseStart');
},

pause() {
  if (!this.running || this.paused) return;

  clearInterval(this.timer);
  this.paused = true;
  this.pauseStart = Date.now();
  localStorage.setItem('timerPaused', true);
localStorage.setItem('timerPauseStart', this.pauseStart);
},

resume() {
  if (!this.running || !this.paused) return;

  this.paused = false;

  if (this.pauseStart) {
    this.pausedTime += (Date.now() - this.pauseStart) / 1000;
    this.pauseStart = null;
  }

  this.timer = setInterval(() => {
    const now = Date.now();
    this.elapsed = Math.floor((now - this.startTime - this.pausedTime * 1000) / 1000);
  }, 1000);
  localStorage.setItem('timerPaused', false);
localStorage.setItem('timerPausedTime', this.pausedTime);
localStorage.removeItem('timerPauseStart');
},

stop() {
  if (!this.running) return;

  clearInterval(this.timer);

  this.running = false;
  this.paused = false;
  this.pauseStart = null;

  localStorage.setItem('timerRunning', 'false');
  localStorage.removeItem('timerStart');
  localStorage.removeItem('timerPaused');
  localStorage.removeItem('timerPausedTime');
  localStorage.removeItem('timerPauseStart');

  this.showNote = true;
},

saveEntry() {
  if (!this.selectedProjectId) return alert("Projekt w√§hlen");
  if (this.elapsed <= 0) return alert("Keine Zeit gemessen");

  const project = this.projects.find(
    p => String(p.id) === String(this.selectedProjectId)
  );

  if (!project) {
    alert("Projekt nicht gefunden");
    return;
  }

  const end = new Date();
  const start = new Date(
    end.getTime() - (this.elapsed + this.pausedTime) * 1000
  );

  const entry = {
    id: crypto.randomUUID(),
    start: start.toISOString(),
    end: end.toISOString(),
    duration: this.elapsed,
    paused: this.pausedTime,
    note: this.note || "",
    exported: false
  };

  project.entries.unshift(entry);
  project.total = project.entries.reduce(
    (sum, e) => sum + e.duration,
    0
  );

  this.save();

  // Reset
  this.elapsed = 0;
  this.pausedTime = 0;
  this.note = "";
  this.showNote = false;
  this.running = false;
  this.paused = false;
  this.startTime = null;
  this.pauseStart = null;

  localStorage.setItem('timerRunning', 'false');
  localStorage.removeItem('timerStart');
  localStorage.removeItem('timerPaused');
  localStorage.removeItem('timerPausedTime');
  localStorage.removeItem('timerPauseStart');
},

deleteEntry(index) {
  if (!confirm("Eintrag wirklich l√∂schen?")) return;

  const entry = this.selectedProject.entries[index];

  this.selectedProject.entries.splice(index, 1);

  this.selectedProject.total =
    this.selectedProject.entries.reduce((sum, e) => sum + e.duration, 0);

  this.save();
},


skipNote() {
  this.note = "";
  this.showNote = false;
},

    addProject() {
      const name = prompt("Projektname");
      if (!name) return;
      this.projects.push({
        id: String(Date.now()),
        name,
        entries: [],
        todos: [],
        total: 0,
        color: `hsl(${Math.random() * 360},30%,55%)`
      });
      this.save();
    },

        deleteProject() {
      if (!confirm("Projekt wirklich l√∂schen?")) return;
      const index = this.projects.findIndex(p => p.id === this.selectedProject.id);
      if (index === -1) return;
      this.projects.splice(index, 1);
      this.selectedProject = null;
      this.selectedProjectId = '';
      this.save();
    },

    openProject(p) {
      this.selectedProject = p;
      if (!p.entries) p.entries = [];
      if (!p.todos) p.todos = [];
    },

save() {
  localStorage.setItem('projects', JSON.stringify(this.projects));
  localStorage.setItem('dailyAdjustments', JSON.stringify(this.dailyAdjustments));
},
    updateDuration(entry) {
  const start = new Date(entry.start);
  const end = new Date(entry.end);

  // Dauer in Sekunden berechnen
entry.duration = Math.max(0, Math.round((end - start)/1000) - (entry.paused || 0));

  // Projekt-Total neu berechnen
  const project = this.projects.find(p => p.entries.includes(entry));
  if (project) {
    project.total = project.entries.reduce((sum, e) => sum + e.duration, 0);
  }

  this.save();
},


addTodo() {
  if (!this.newTodo || !this.newTodo.trim()) return;

  if (!this.selectedProject.todos) {
    this.selectedProject.todos = [];
  }

  this.selectedProject.todos.push({
    id: crypto.randomUUID(),
    text: this.newTodo.trim(),
    done: false
  });

  this.newTodo = "";
  this.save();
},

deleteTodo(index) {
  if (!confirm("To-Do wirklich l√∂schen?")) return;

  this.selectedProject.todos.splice(index, 1);
  this.save();
},

async exportAll() {

  if (!this.selectedUser) {
    alert("Bitte Benutzer w√§hlen");
    return;
  }

  const data = this.projects
    .map(p => ({
      users: [
        "Max",
        "Anna",
        "Tim"
      ],
      selectedUser: "Max",
      id: p.id,
      name: p.name,
      entries: p.entries.filter(e => !e.exported)
    }))
    .filter(p => p.entries.length);

  if (!data.length) {
    alert("Keine neuen Eintr√§ge");
    return;
  }

  try {
    const res = await fetch(EXPORT_URL, {
  method: "POST",
body: JSON.stringify({
  user: this.selectedUser,
  projects: data,
  dailyAdjustments: Object.fromEntries(
    Object.entries(this.dailyAdjustments)
      .filter(([date, value]) =>
        value !== 0 && !this.exportedAdjustments[date]
      )
  )
})
});


    if (!res.ok) throw new Error("Export fehlgeschlagen");

    data.forEach(p => {
      const orig = this.projects.find(x => x.id === p.id);
      p.entries.forEach(e => {
        const o = orig.entries.find(x => x.id === e.id);
        if (o) o.exported = true;
      });
    });
    // √úberstunden als exportiert markieren
Object.keys(this.dailyAdjustments).forEach(date => {
  if (this.dailyAdjustments[date] !== 0) {
    this.exportedAdjustments[date] = true;
  }
});

localStorage.setItem(
  'exportedAdjustments',
  JSON.stringify(this.exportedAdjustments)
);

    this.save();
    alert("Export erfolgreich ‚úÖ");

    const now = new Date().toISOString();
    localStorage.setItem('lastExport', now);
    this.lastExport = now;

  } catch (err) {
    console.error(err);
    alert("Fehler beim Export ‚ùå");
  }
},


    formatTime(iso) {
      const d = new Date(iso);
      return d.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
    },

    formatDay(isoDay) {
      const d = new Date(isoDay);
      return d.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric' });
    },
    openDay(day) {
  this.selectedDay = day;
},
  }
}).mount('#app');
</script>

</body>
</html>
