<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zeiterfassung</title>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<link href="https://fonts.googleapis.com/css2?familyInter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="apple-touch-icon" href="apple-touch-icon.png">

<style>
:root{
  --bg:#c0d2d3;
  --card:#fff;
  --border:#66819b9d;
  --text:#1f1f1f;
  --accent:#427da1;
  --danger:#c94a4a;

}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Inter',system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* NAV */
nav{display:flex;background:#1f1f1f}
nav button{
  flex:1;padding:1.2rem;border:none;background:none;
  color:#aaa;font-size:1.1rem
}
nav button.active{
  color:#fff;border-bottom:8px solid var(--accent)
}

/* PAGE */
.page{
  min-height:calc(100vh - 56px);
  padding:1.4rem;
  display:flex;
  flex-direction:column;
}

/* HOME */
.timer-wrapper{flex:1;display:flex;flex-direction:column;align-items:center}
.top-area{width:100%;max-width:380px}

.project-select{
  width:100%;font-size:1.3rem;padding:1rem;
  border-radius:18px;border:1px solid var(--border);
  background-color: #ffffff;
  text-align:center;font-weight:700
}

.timer{
  margin-top:1.6rem;
  width:100%;
  text-align:center;
  font-family:"Courier New",monospace;
  font-size:clamp(2.4rem,10vw,3.6rem);
  line-height:1.3;
  padding:1.6rem .6rem;
  border-radius:28px;
  background:#fafafa;
  border:2px solid var(--border);
}

.flex-spacer{flex:1}

/* MAIN BUTTON */
.main-btn{
  width:220px;height:220px;border-radius:50%;
  border:none;font-size:1.5rem;font-weight:800;
  color:#fff;background:var(--accent);
  box-shadow:0 14px 30px rgba(0,0,0,.18);
  margin-bottom:4rem
}
.main-btn.stop{
  background:var(--danger);
  animation:pulse 1.4s infinite
}
@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(201,74,74,.6)}
  70%{box-shadow:0 0 0 22px rgba(201,74,74,0)}
  100%{box-shadow:0 0 0 0 rgba(201,74,74,0)}
}

/* PROJECT LIST */
.project-item{
  position:relative;
  background:#fff;
  border:1px solid var(--border);
  border-radius:20px;
  padding:0.6rem 0.6rem 0.6rem 1.5rem;
  margin-bottom:1.1rem;
  font-size:1rem;
  font-weight:700;
}
.project-item span{
  display:block;margin-top:.4rem;font-size:0.75rem
}
.project-item::before{
  content:"";position:absolute;left:0;top:12%;bottom:12%;
  width:8px;border-radius:8px;background:var(--accent)
}

/* MODAL */
.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.45);
  display:flex;justify-content:center;align-items:center;
  z-index:20
}
.modal-card{
  position:relative;background:#fff;width:92%;
  max-width:480px;border-radius:24px;
  padding:1.6rem 1.4rem;
  max-height:85vh;overflow-y:auto
}
.modal-close{
  position:absolute;top:.7rem;right:.7rem;
  width:36px;height:36px;border-radius:50%;
  background:#999;color:#fff;border:none;
  font-size:1.3rem;font-weight:700
}

textarea{
  width:100%;min-height:100px;padding:.8rem;
  border-radius:14px;border:1px solid var(--border);
  font-size:1rem
}

.entry{border-bottom:1px solid #eee;padding:.9rem 0}
.entry-top{display:flex;justify-content:space-between;align-items:center}
.entry-delete{
  border:none;background:#eee;border-radius:50%;
  width:32px;height:32px
}

/* BOTTOM ACTIONS */
.bottom-actions{display:flex;gap:.8rem;margin-top:1rem}
.bottom-actions button{
  flex:1;padding:.9rem;border-radius:16px;
  border:none;font-size:1.1rem;font-weight:600;
  background:var(--accent);color:#fff
}
</style>
</head>

<body>
<div id="app">

<nav>
  <button :class="{active:tab==='home'}" @click="tab='home'">Timer</button>
  <button :class="{active:tab==='projects'}" @click="tab='projects'">√úbersicht</button>
</nav>

<!-- HOME -->
<div v-if="tab==='home'" class="page">
  <div class="timer-wrapper">
    <div class="top-area">
      <select class="project-select" v-model="selectedProjectId">
        <option disabled value="">Projekt ausw√§hlen</option>
        <option v-for="p in projects" :value="p.id">{{p.name}}</option>
      </select>
      <div class="timer">{{formattedTime}}</div>
    </div>

    <div class="flex-spacer"></div>

    <button v-if="!running" class="main-btn" @click="start">Start</button>
    <button v-else class="main-btn stop" @click="stop">Stop</button>
  </div>
</div>

<!-- NOTE MODAL -->
<div v-if="showNote" class="modal">
  <div class="modal-card">
    <button class="modal-close" @click="skipNote">√ó</button>
    <h3>Beschreibung</h3>
    <textarea v-model="note"></textarea>
    <button style="margin-top:1rem;width:100%" @click="saveEntry">Speichern</button>
  </div>
</div>

<!-- PROJECT OVERVIEW -->
<div v-if="tab==='projects'" class="page">
  <div v-for="p in projects" :key="p.id"
       class="project-item"
       :style="{'--accent':p.color}"
       @click="openProject(p)">
    {{p.name}}
    <span>{{(p.total/3600).toFixed(2)}} Stunden</span>
  </div>

  <div class="bottom-actions">
    <button @click="addProject">Projekt hinzuf√ºgen</button>
    <button @click="exportAll">Export</button>
  </div>
  <label style="display:block;margin-bottom:.4rem; margin-top: 1.5rem;"> </label>

<select v-model="selectedUser"
        style="width:100%;padding:0.8rem;margin-bottom:1rem; background-color: #ffffff;">
  <option disabled value="">Benutzer ausw√§hlen</option>
  <option v-for="u in users" :key="u" :value="u">
    {{ u }}
  </option>
</select>

</div>

<!-- PROJECT DETAIL -->
<div v-if="selectedProject" class="modal">
  <div class="modal-card">
    <button class="modal-close" @click="selectedProject=null">√ó</button>

    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">{{selectedProject.name}}</h3>
      <button
        style="border:none;background:none;color:var(--danger);font-size:1.1rem"
        @click="deleteProject"
      >
        Projekt l√∂schen
      </button>
    </div>

    <div v-for="(e,i) in selectedProject.entries" :key="e.id" class="entry">
      <div class="entry-top">
        <strong>{{formatDate(e.start)}}</strong>
        <button class="entry-delete" @click="deleteEntry(i)">üóëÔ∏è</button>
      </div>
      <span
        style="cursor:pointer;text-decoration:underline"
        @click="openEditDuration(e)"
      >
<div v-if="editDurationEntry === e"
     style="margin-top:.4rem">

  <input type="number"
         step="0.25"
         min="0"
         v-model.number="editDurationHours"
         style="width:90px;padding:.3rem">

  <button @click="saveEditedDuration"
          style="margin-left:.4rem">
    ‚úì
  </button>
</div>

<span v-else
      style="cursor:pointer;text-decoration:underline"
      @click="openEditDuration(e)">
  ‚è± {{(e.duration/3600).toFixed(2)}} h
</span>
      </span>
      <textarea v-model="e.note" @change="save"></textarea>
    </div>
    <hr style="margin:1.4rem 0">

<h3 style="margin:.4rem 0">‚òëÔ∏è To-Dos</h3>

<div v-for="(t,i) in selectedProject.todos" :key="t.id"
     style="display:flex;align-items:center;gap:.6rem;margin:.5rem 0">

  <input type="checkbox"
         v-model="t.done"
         @change="save"
         style="transform:scale(1.2)">

  <input type="text"
         v-model="t.text"
         @change="save"
         placeholder="To-Do"
         style="flex:1;border:none;border-bottom:1px solid #ddd;
                font-size:1rem;background:transparent">

  <button @click="deleteTodo(i)"
          style="border:none;background:#eee;border-radius:50%;
                 width:28px;height:28px">
    üóëÔ∏è
  </button>
</div>

<button @click="addTodo"
        style="margin-top:.6rem;width:100%;
               border:none;padding:.6rem;
               border-radius:12px;
               background:#eee;font-weight:600">
  + To-Do hinzuf√ºgen
</button>

  </div>
</div>

</div>

<script>
const EXPORT_URL = "https://script.google.com/macros/s/AKfycbx0HbkmzbJg52ARqht_5lR0BRcvay8fVOUO7UjubZGBDHp6y3MiIt4bjlkEz98dFHyqcg/exec";

const { createApp } = Vue;

createApp({
  data() {
    return {
      tab: 'home',
      projects: JSON.parse(localStorage.getItem('projects') || '[]'),
      selectedProjectId: '',
      selectedProject: null,
      running: false,
      startTime: null,
      timer: null,
      elapsed: 0,
      showNote: false,
      note: '',
      editDurationEntry: null,
      editDurationHours: 0,
      users: ["Bennet", "Dennis", "Till", "Nicole", "Patrick",],
      selectedUser: localStorage.getItem("selectedUser") || "",


    }
  },

  computed: {
    formattedTime() {
      const s = Math.floor(this.elapsed);
      return (
        String(Math.floor(s / 3600)).padStart(2, '0') + ':' +
        String(Math.floor((s % 3600) / 60)).padStart(2, '0') + ':' +
        String(s % 60).padStart(2, '0')
      );
    }
  },

    watch: {
    selectedUser(newVal) {
      if (newVal) {
        localStorage.setItem("selectedUser", newVal);
      }
    }
  },


  methods: {

    start() {
      if (!this.selectedProjectId) return alert("Projekt w√§hlen");
      this.running = true;
      this.startTime = Date.now();
      this.timer = setInterval(() => {
        this.elapsed = (Date.now() - this.startTime) / 1000;
      }, 1000);
    },

    stop() {
      clearInterval(this.timer);
      this.running = false;
      this.showNote = true;
    },

    saveEntry() {
      const p = this.projects.find(p => p.id === this.selectedProjectId);
      p.entries.unshift({
        id: crypto.randomUUID(),
        start: new Date().toISOString(),
        duration: this.elapsed,
        note: this.note,
        exported: false
      });
      p.total += this.elapsed;
      this.resetAfterSave();
    },

    skipNote() {
      this.note = '';
      this.saveEntry();
    },

    resetAfterSave() {
      this.elapsed = 0;
      this.note = '';
      this.showNote = false;
      this.save();
    },

    addProject() {
      const name = prompt("Projektname");
      if (!name) return;
      this.projects.push({
        id: Date.now(),
        name,
        entries: [],
        todos: [],
        total: 0,
        color: `hsl(${Math.random() * 360},30%,55%)`
      });
      this.save();
    },

    openProject(p) {
      if (!p.todos) p.todos = [];   // ‚úÖ Fallback
      this.selectedProject = p;
    },

    deleteEntry(i) {
      const e = this.selectedProject.entries[i];
      this.selectedProject.total -= e.duration;
      this.selectedProject.entries.splice(i, 1);
      this.save();
    },

    deleteProject() {
      if (!confirm("Projekt wirklich l√∂schen?")) return;
      const index = this.projects.findIndex(p => p.id === this.selectedProject.id);
      if (index === -1) return;
      this.projects.splice(index, 1);
      this.selectedProject = null;
      this.selectedProjectId = '';
      this.save();
    },
    addTodo() {
  this.selectedProject.todos.unshift({
    id: crypto.randomUUID(),
    text: "",
    done: false
  });
  this.save();
  },

  deleteTodo(i) {
    this.selectedProject.todos.splice(i, 1);
    this.save();
  },

openEditDuration(entry) {
  this.editDurationEntry = entry;
  this.editDurationHours = +(entry.duration / 3600).toFixed(2);
},

saveEditedDuration() {
  const entry = this.editDurationEntry;
  const project = this.selectedProject;

  project.total -= entry.duration;
  entry.duration = Math.round(this.editDurationHours * 3600);
  project.total += entry.duration;

  this.editDurationEntry = null;
  this.save();
},



async exportAll() {

  if (!this.selectedUser) {
    alert("Bitte Benutzer w√§hlen");
    return;
  }

  const data = this.projects
    .map(p => ({
      users: [
        "Max",
        "Anna",
        "Tim"
      ],
      selectedUser: "Max",
      id: p.id,
      name: p.name,
      entries: p.entries.filter(e => !e.exported)
    }))
    .filter(p => p.entries.length);

  if (!data.length) {
    alert("Keine neuen Eintr√§ge");
    return;
  }

  try {
    const res = await fetch(EXPORT_URL, {
  method: "POST",
  body: JSON.stringify({
    user: this.selectedUser,
    projects: data
  })
});


    if (!res.ok) throw new Error("Export fehlgeschlagen");

    data.forEach(p => {
      const orig = this.projects.find(x => x.id === p.id);
      p.entries.forEach(e => {
        const o = orig.entries.find(x => x.id === e.id);
        if (o) o.exported = true;
      });
    });

    this.save();
    alert("Export erfolgreich ‚úÖ");

  } catch (err) {
    console.error(err);
    alert("Fehler beim Export ‚ùå");
  }
},

    formatDate(iso) {
      const d = new Date(iso);
      return d.toLocaleDateString('de-DE') + ' ' +
        d.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
    },

    save() {
      localStorage.setItem('projects', JSON.stringify(this.projects));
    }
  }
}).mount('#app');
</script>

</body>
</html>
